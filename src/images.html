<!DOCTYPE html>
<html>
<head>
  <!-- Compiled and minified CSS -->
  <!--Import Google Icon Font-->
  <link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Compiled and minified JavaScript -->

</head>
<body>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>

<script src="/assets/camera51.js"></script>


<script src="/assets/dragdropfile/filereader.js"></script>
<script src="/assets/dragdropfile/script.js"></script>
<link href="/assets/dragdropfile/style.css" rel="stylesheet">

<style type="text/css">
  body{
    background-color: whitesmoke;

  }
  .resultImg {
    background-color: white;
    max-height: 200px;max-width: 200px;
  }
  .modal {
    max-height: 100%;
    width: 80%;

  }
  .roboto {
    font-family: Roboto, sans-serif;
    font-size: initial
  }
  a {
    cursor: pointer !important;
  }
</style>

<div id="dropbox">
  <div class="text">
    Drop Images Here
  </div>
</div>
<div id="imageList">
</div>

<!-- Modal Structure -->
<div id="modal1" class="modal" style="margin-bottom: -8px; ">
  <div class="modal-content" style="padding-top: 20px;padding-bottom: 5px;background-color: #393b4b;">
    <a style="position: absolute; right: 0px; top: 16px;"
       class=" modal-action modal-close waves-effect waves-light btn-flat">
      <i style="font-size: 31px;color: white" class="material-icons right">close</i>
    </a>
    <div style="font-family: Roboto, sans-serif; font-size: 24px; color: white;margin-bottom: 6px;">Background Remover Edit</div>
    <a id="camera51-btn-mark-object" class="waves-effect waves-light btn-flat roboto"
       style="color:#7cb342;font-size: initial;padding: 0px;" onclick="camera51.setColor('colorFG');">
      <i class="material-icons left" style="color:#7cb342;padding-right: 0px;margin-right: 10px;font-size: 24px;">add_circle</i>
      Mark Object
    </a>
    <a id="camera51-btn-mark-background" class="waves-effect waves-light  btn-flat roboto"
       style="margin-left:10px;color:#f44336;font-size: initial;padding: 0px;" onclick="camera51.setColor('colorBG');">
      <i class="material-icons left" style="color:#f44336;padding-right: 0px;margin-right: 10px;font-size: 24px;">remove_circle</i>
      Mark Background
    </a>
    <a id="camera51-btn-undo" class="waves-effect waves-light btn-flat roboto" style="color: white;font-size: initial;"
       onclick="camera51.undo()">UNDO</a>
    <br>
    <a id="camera51-zoom-in" class="waves-effect waves-circle transparent"
       style="position: absolute;top: 148px;left: 30px" onmousedown="camera51.onclickLongZoomIn()"
       onmouseup="camera51.onmouseupLongZoomIn()">
      <i class="material-icons right small" style="color:#393b4b;">zoom_in</i>
    </a>
    <a id="camera51-zoom-out" class="waves-effect waves-circle transparent"
       style="position: absolute;top: 182px;left: 30px" onmousedown="camera51.onclickLongZoomOut()"
       onmouseup="camera51.onmouseupLongZoomOut()">
      <i class="material-icons right small" style="color:#393b4b;">zoom_out</i>
    </a>
  </div>
  <div class="progress" style="margin: 0px;visibility: hidden;height: 3px" id="camera51-loader">
    <div class="indeterminate"></div>
  </div>
  <div>
    <div id="ad54" style="height:500px;width:100%"></div>
  </div>
  <div class="modal-footer" style="background-color: white ">
    <a id="camera51-btn-save-image" class="waves-effect waves-light btn-large btn-flat roboto" onclick="camera51.saveImage()"
       style="margin-right: 20px; background-color: #393b4b !important;color: white !important;">Save Image</a>
    <a id="camera51-btn-show-result" class="waves-effect waves-light  btn-large btn-flat roboto"
       style="color:black !important;margin-right: 20px; background-color: #ffffff !important;" onclick="camera51.showResult()">Show Result</a>
  </div>
</div>

<script>

  var apiUrl = "http://ec2-54-152-227-158.compute-1.amazonaws.com/";
  //var apiUrl = "http://localhost:8080/";
  var sqsUrl = null;
  var customerId = 3;
  var customerToken = "a059e275-52e0-4524-8050-3872fdd8d9af";
  var sessionToken = null;
  var camera51ShowImage = new Camera51ShowImage(); // Object, functions for registering analytics events.

  window.onload = function(){
    getSession();
    initCamera51({
      elementId: "ad54", // Div to insert the iframe.
      apiUrl: apiUrl,
      customerId: customerId, //
      callbackFuncSave: function(imageUrl, elementIdToResponse){
        elementIdToResponse(imageUrl);

      },
    });
  };

  function getSession(){
    var cookieForSession = "camera51.sessionToken";
   if(camera51ShowImage.getCookie(cookieForSession)){
     sessionToken = camera51ShowImage.getCookie(cookieForSession);
     console.log("cookie",sessionToken);
     createQueue();
     return sessionToken;
   }

    var settings = {
      "async": false,
      //  "crossDomain": true,
      "url": apiUrl  + "Camera51Server/getSessionToken",
      "method": "POST",
      "headers": {
        "content-type": "application/x-www-form-urlencoded"
      },
      "data": {
        "token": customerToken,
        "customerId": customerId,
      }
    };

    $.ajax(settings).done(function (response) {
      sessionToken = response.response["sessionToken"];
      var date = new Date();
      date.setTime(date.getTime() + (60 * 60 * 1000));
      document.cookie =
        cookieForSession +'=' + sessionToken +
        '; expires=' + date.toUTCString() +
        '; path=/';
      console.log(sessionToken);
      createQueue();
    });
  }

  function createQueue(){
    var queueStringIdentifier = "camera51.sqsUrl";
    if(camera51ShowImage.getCookie(queueStringIdentifier)){
      sqsUrl = camera51ShowImage.getCookie(queueStringIdentifier);
      return sqsUrl;
    }
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == 4 && xhttp.status == 200) {
        var res = JSON.parse(xhttp.responseText);
        sqsUrl = res.response["queueURL"];
        var date = new Date();
        var days = 1000 * 60 * 60 * 24 * 10;
        date.setTime(date.getTime() + days);
        document.cookie =
          queueStringIdentifier +'=' + sqsUrl +
          '; expires=' + date.toUTCString() +
          '; path=/';

      }
    };
    xhttp.open("POST", apiUrl  + "Camera51Server/createQueue", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send("token="+sessionToken+"&customerId="+customerId);

  /*  $.ajax(settings).done(function (response) {

      if(response.hasOwnProperty('response')){
        sqsUrl = response.response["queueURL"];
        console.log(sqsUrl);
        camera51ShowImage.checkUpdatesSQS();
      }else {
        console.error(response);
      }

    });*/
  }


  function sqsListener(imageId, origImgUrl) {
    var settings = {
      //  "async": true,
      //  "crossDomain": true,
      "url": apiUrl + "Camera51Server/processImageAsync",
      "method": "POST",
      "headers": {
        "content-type": "application/x-www-form-urlencoded"
      },
      "data": {
        "origImgUrl": origImgUrl,
        "token": customerToken,
        "customerId": customerId,
        "callbackURL": sqsUrl,
        "trackId" : origImgUrl
      }
    };

    $.ajax(settings).done(function (response) {
      var trackId = response.response["trackId"];
      var element = document.getElementById("resultPreview-" + imageId);

      camera51ShowImage.addSearchArray(element, trackId);
    });
  };

    function malabiShowImageCallback(elem, img, processingResultCode, trackId){

      if(processingResultCode == 0){
        $(elem).html('<img id="theImg-' + elem.id +  '" src="'+img +'" style="width: 100%;height: auto;" onclick="openEditor(\''+trackId+'\',\''+ elem.id+'\');" />');
      }
      if(processingResultCode > 0) {
        $(elem).html('error ' + processingResultCode);
      }
    };

  function openEditor(trackId, elementIdToResponse){

    var customerIda = customerId;
    var trackId = trackId;
    var todoOnSaveWithResult = function(resultUrl){
      console.log(resultUrl);
      $("#theImg-"+elementIdToResponse).attr('src', resultUrl);
      $('#modal1').closeModal();

    };
    $('#modal1').openModal();
    camera51.setDataTrackId({'customerId': customerIda,
      'trackId': trackId}, todoOnSaveWithResult);
  }

</script>
</body>
</html>

