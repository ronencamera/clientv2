<!DOCTYPE html>
<html>
<head>
  <!-- Compiled and minified CSS -->
  <!--Import Google Icon Font-->
  <link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Compiled and minified JavaScript -->

</head>
<body>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>

<script src="/assets/camera51.js"></script>


<script src="/assets/dragdropfile/filereader.js"></script>
<script src="/assets/dragdropfile/script.js"></script>
<link href="/assets/dragdropfile/style.css" rel="stylesheet">

<style type="text/css">
  body{
    background-color: whitesmoke;

  }
  .resultImg {
    background-color: white;
    max-height: 200px;max-width: 200px;
  }
  .modal {
    max-height: 100%;
    width: 80%;

  }
</style>

<div id="dropbox">
  <div class="text">
    Drop Images Here
  </div>
</div>
<div id="imageList">
</div>

<!-- Modal Structure -->
<div id="modal1" class="modal">

  <div class="modal-content">
    <a style="position: absolute; right: 0px; top: 16px;"  class=" modal-action modal-close waves-effect waves-light btn-flat"><i style="font-size: 31px;" class="material-icons right">close</i></a>
    <h4>Background Remover Edit</h4>
    <a id="camera51-btn-mark-object" class="waves-effect waves-light btn "  style="background-color: rgb(124, 179, 66)" onclick="camera51.setColor('colorFG');"><i class="material-icons left" >add_circle</i>Mark Object</a>
    <a id="camera51-btn-mark-background" class="waves-effect waves-light btn" style="background-color: rgb(244, 67, 54)"  onclick="camera51.setColor('colorBG');"><i class="material-icons left">remove_circle</i>Mark Background</a>
    <a id="camera51-btn-undo" class="waves-effect waves-light btn" style="background-color: #E1F5FE;color: #000;" onclick="camera51.undo()">UNDO</a>
    <br>
    <a id="camera51-zoom-in" class="waves-effect waves-circle transparent" style="position: absolute;top: 148px;left: 30px" onmousedown="camera51.onclickLongZoomIn()" onmouseup="camera51.onmouseupLongZoomIn()" >
      <i class="material-icons right small">zoom_in</i>
    </a>
    <a id="camera51-zoom-out" class="waves-effect waves-circle transparent" style="position: absolute;top: 182px;left: 30px" onmousedown="camera51.onclickLongZoomOut()" onmouseup="camera51.onmouseupLongZoomOut()">
      <i class="material-icons right small" >zoom_out</i>
    </a>
    <div class="progress" style="margin-bottom: 0px;visibility: hidden" id="camera51-loader">
      <div class="indeterminate"></div>
    </div>
    <div id="ad54" style="height:500px;width:100%">
    </div>
  </div>
  <div class="modal-footer">
    <a id="camera51-btn-save-image" class="waves-effect waves-light light-blue btn-large" onclick="camera51.saveImage()" style="margin-right: 20px;">Save Image</a>
    <a id="camera51-btn-show-result" class="waves-effect waves-light grey lighten-5 btn-large" style="color:black;margin-right: 20px;" onclick="camera51.showResult()">Show Result</a>
  </div>
</div>

<script>

  var apiUrl = "http://ec2-54-152-227-158.compute-1.amazonaws.com/";
  var sqsUrl = null;
  var customerId = 3;
  var customerToken = "a059e275-52e0-4524-8050-3872fdd8d9af";
  var sessionToken = null;
  var camera51ShowImage = new Camera51ShowImage(); // Object, functions for registering analytics events.


  window.onload = function(){
    getSession();
    initCamera51({
      elementId: "ad54", // Div to insert the iframe.
      apiUrl: "http://ec2-54-152-227-158.compute-1.amazonaws.com",
      customerId: customerId, //
      callbackFuncSave: function(response){
        Materialize.toast("Image saved, new URL: " + JSON.stringify(response),4000,"", 4000);
      },
    });
  };

  function getSession(){
    var settings = {
      "async": false,
      //  "crossDomain": true,
      "url": apiUrl  + "Camera51Server/getSessionToken",
      "method": "POST",
      "headers": {
        "content-type": "application/x-www-form-urlencoded"
      },
      "data": {
        "token": customerToken,
        "customerId": customerId,
      }
    };

    $.ajax(settings).done(function (response) {
      sessionToken = response.response["sessionToken"];
      console.log(sessionToken);
      createQueue();
    });
  }

  function createQueue(){
    var settings = {
      "async": false,
      //  "crossDomain": true,
      "url": apiUrl  + "Camera51Server/createQueue",
      "method": "POST",
      "headers": {
        "content-type": "application/x-www-form-urlencoded"
      },
      "data": {
        "token": sessionToken,
        "customerId": customerId,
      }
    };

    $.ajax(settings).done(function (response) {
      sqsUrl = response.response["queueURL"];
      console.log(sqsUrl);
      camera51ShowImage.checkUpdatesSQS();
    });
  }


  function sqsListener(imageId, origImgUrl) {
    var settings = {
      //  "async": true,
      //  "crossDomain": true,
      "url": apiUrl + "Camera51Server/processImageAsync",
      "method": "POST",
      "headers": {
        "content-type": "application/x-www-form-urlencoded"
      },
      "data": {
        "origImgUrl": origImgUrl,
        "token": customerToken,
        "customerId": customerId,
        "callbackURL": sqsUrl,
        "trackId" : origImgUrl
      }
    };

    $.ajax(settings).done(function (response) {
      var trackId = response.response["trackId"];
      var element = document.getElementById("resultPreview-" + imageId);

      camera51ShowImage.addSearchArray(element, trackId);
    });
  };

    function malabiShowImageCallback(elem, img, processingResultCode, trackId){

      if(processingResultCode == 0){
        $(elem).html('<img id="theImg" src="'+img +'" style="width: 100%;height: auto;" onclick="openEditor(\''+trackId+'\');" />');
      }
      if(processingResultCode > 0) {
        $(elem).html('error ' + processingResultCode);
      }
    };

  function openEditor(trackId){

    var customerIda = customerId;
    var originalImageUrl = trackId;
    $('#modal1').openModal();
    camera51.setDataTrackId({'customerId': customerIda,
      'trackId': trackId});
  }

</script>
</body>
</html>

